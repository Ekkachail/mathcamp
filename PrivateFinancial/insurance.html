<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Portfolio Analysis</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8fafc; }
        .card { @apply bg-white rounded-xl shadow-sm border border-gray-200; }
        .table-header { @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-b border-gray-100; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="mr-4 text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fa-solid fa-arrow-left"></i>
                    </a>
                    <i class="fa-solid fa-shield-heart text-pink-500 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">วิเคราะห์กรมธรรม์ประกันภัย</h1>
                </div>
            </div>
        </div>
    </nav>

    <!-- Config Alert -->
    <div id="configAlert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 mx-auto max-w-7xl mt-4">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <span class="font-bold">โหมดข้อมูลจำลอง:</span> หากต้องการใช้ข้อมูลจริง กรุณาเตรียมไฟล์ Google Sheet ตามรูปแบบที่แนะนำ (เพิ่มคอลัมน์ SumAssured)
                </p>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Controls Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <!-- Policy Selector & Info -->
            <div class="lg:col-span-2 card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fa-solid fa-file-contract text-indigo-500 mr-2"></i> เลือกกรมธรรม์
                    </h2>
                    <select id="policySelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-64 p-2.5">
                        <option>Loading...</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">ทุนประกัน (Sum Assured)</p>
                        <p class="text-xl font-bold text-indigo-700" id="infoSumAssured">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">เบี้ยประกัน/ปี</p>
                        <p class="text-xl font-bold text-gray-900" id="infoPremium">-</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">ระยะเวลาส่งเบี้ย</p>
                        <p class="text-xl font-bold text-gray-900" id="infoDuration">-</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg border border-green-100">
                        <p class="text-xs text-green-600">สถานะปัจจุบัน</p>
                        <p class="text-xl font-bold text-green-700" id="infoStatus">-</p>
                    </div>
                </div>
            </div>

            <!-- Goal Calculator -->
            <div class="card p-6 bg-gradient-to-br from-gray-800 to-gray-900 text-white">
                <h2 class="text-lg font-semibold mb-4 text-white flex items-center">
                    <i class="fa-solid fa-crosshairs text-green-400 mr-2"></i> เป้าหมายกำไร
                </h2>
                <p class="text-sm text-gray-400 mb-4">ระบุ % กำไรที่ต้องการ (เทียบกับเงินต้นที่จ่ายไป) เพื่อหาปีที่ควรเวนคืน</p>
                
                <div class="flex gap-2 mb-4">
                    <input type="number" id="targetProfitInput" placeholder="เช่น 5, 10, 20" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5">
                    <button onclick="calculateTargetYear()" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                        คำนวณ
                    </button>
                </div>

                <div id="targetResult" class="hidden p-4 bg-white/10 rounded-lg border border-white/20 text-center animate-pulse">
                    <p class="text-gray-300 text-xs">เพื่อให้ได้กำไร <span id="resTargetPct" class="text-green-300 font-bold"></span>%</p>
                    <p class="mt-2 text-sm">ควรเวนคืนในปีที่ <span id="resYear" class="text-2xl font-bold text-white"></span></p>
                    <p class="text-xs text-gray-400 mt-1">(ปี พ.ศ. <span id="resYearAD"></span>)</p>
                </div>
            </div>
        </div>

        <!-- Analysis Table -->
        <div class="card overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800">ตารางวิเคราะห์มูลค่าเวนคืน (CV คำนวณจาก % ของทุนประกัน)</h3>
                <span class="text-xs text-gray-500">*ต้นทุน = เบี้ย x ปีที่ชำระ</span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="table-header">ปีที่ (Year)</th>
                            <th class="table-header text-right">ต้นทุนเบี้ยสะสม (Paid Cost)</th>
                            <th class="table-header text-right">อัตราเวนคืน (% CV Rate)</th>
                            <th class="table-header text-right text-indigo-600">มูลค่าเวนคืน (CV Value)</th>
                            <th class="table-header text-right">กำไร/ขาดทุน (THB)</th>
                            <th class="table-header text-right">กำไร/ขาดทุน (%)</th>
                            <th class="table-header text-center">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- JS Generated Content -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // ==========================================
        // ⚙️ CONFIGURATION (ส่วนที่ต้องแก้ไข)
        // ==========================================
        
        const useMockData = false; 
        
        // CSV Header ต้องมี: PolicyName, StartDate, Premium, SumAssured, DurationYears, CoverageYears, CV_Rates
        // CV_Rates: ให้ใส่เป็น % แยกด้วยคอมม่า (เช่น 10,20,30 หมายถึง 10% ของทุน, 20% ของทุน)
        const insuranceSheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhtlb9rQlKGTGedKmHvGa6Lh_7CiDSmXUad79QABQGEr3h8Q3_mzWzD_s-We5nNxb8_qdEDDcTVINn/pub?gid=1735189322&single=true&output=csv";

        // ==========================================
        // 1. MOCK DATA (ข้อมูลจำลอง)
        // ==========================================
        const mockPolicies = [
            {
                id: 1,
                name: "ประกัน axa โอซิส (Mock)",
                startDate: "2025-10-01",
                premium: 18000,
                sumAssured: 300000, // ทุนประกัน
                duration: 10,
                coverage: 20,
                // Rate เป็น % ของทุนประกัน (เช่น ปีที่ 3 ได้คืน 10% ของ 300,000 = 30,000)
                cvRate: [0, 0, 5, 15, 25, 35, 45, 55, 65, 75, 80, 85, 90, 95, 100, 105, 110, 115, 120, 125] 
            },
            {
                id: 2,
                name: "ประกัน axa บำนาญเธรด (Mock)",
                startDate: "2025-11-01",
                premium: 36000,
                sumAssured: 500000, // ทุนประกัน
                duration: 15,
                coverage: 60,
                cvRate: [0, 5, 10, 15, 20, 25, 30, 35, 45, 55, 65, 75, 85, 95, 105, 115, 125, 135, 145, 155]
            }
        ];

        let policies = [];
        let currentPolicy = null;

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================
        
        if(useMockData) document.getElementById('configAlert').classList.remove('hidden');

        async function init() {
            try {
                if (useMockData) {
                    policies = mockPolicies;
                } else {
                    if (insuranceSheetCSV.includes("YOUR_INSURANCE")) {
                        alert("กรุณาใส่ลิงก์ CSV ของ Google Sheet ประกันภัยก่อนครับ");
                        return;
                    }
                    const rawData = await fetchData(insuranceSheetCSV);
                    // Convert CSV rows to Policy Objects
                    policies = rawData.map((row, index) => {
                        let rates = [];
                        if (row.CV_Rates) {
                            rates = row.CV_Rates.split(',').map(num => parseFloat(num.trim()));
                        }
                        
                        return {
                            id: index,
                            name: row.PolicyName,
                            startDate: row.StartDate,
                            premium: parseFloat(row.Premium ? row.Premium.replace(/,/g, '') : 0),
                            sumAssured: parseFloat(row.SumAssured ? row.SumAssured.replace(/,/g, '') : 0),
                            duration: parseInt(row.DurationYears),
                            coverage: parseInt(row.CoverageYears),
                            cvRate: rates
                        };
                    });
                }
                
                populateSelect();
                if(policies.length > 0) loadPolicy(0);

            } catch (error) {
                console.error(error);
                alert("เกิดข้อผิดพลาดในการโหลดข้อมูล: " + error.message);
            }
        }

        function fetchData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        function populateSelect() {
            const select = document.getElementById('policySelect');
            select.innerHTML = '';
            policies.forEach((p, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => loadPolicy(e.target.value));
        }

        // ==========================================
        // 3. LOGIC & CALCULATION (UPDATED)
        // ==========================================
        function loadPolicy(index) {
            currentPolicy = policies[index];
            const p = currentPolicy;

            // Update Info Cards
            document.getElementById('infoSumAssured').textContent = formatMoney(p.sumAssured);
            document.getElementById('infoPremium').textContent = formatMoney(p.premium);
            document.getElementById('infoDuration').textContent = `${p.duration} ปี`;
            
            // Calculate Status
            const startYear = moment(p.startDate).year();
            const currentYear = moment().year();
            const policyYear = currentYear - startYear + 1;
            
            let statusText = "Active (ปีที่ " + policyYear + ")";
            if(policyYear > p.coverage) statusText = "ครบสัญญา (Matured)";
            document.getElementById('infoStatus').textContent = statusText;

            // Generate Table
            renderTable(p);
            
            // Reset Calculator
            document.getElementById('targetResult').classList.add('hidden');
            document.getElementById('targetProfitInput').value = '';
        }

        function renderTable(p) {
            const tbody = document.getElementById('analysisTableBody');
            tbody.innerHTML = '';

            let cumulativePaid = 0;
            const startYear = moment(p.startDate);
            const maxRows = Math.max(p.coverage, p.cvRate.length);

            for (let i = 0; i < maxRows; i++) {
                const yearNum = i + 1;
                const calendarYear = startYear.clone().add(i, 'years').format('YYYY');
                
                // 1. คำนวณต้นทุน (เบี้ยสะสม)
                // Cost increases only during the premium paying duration
                if (yearNum <= p.duration) {
                    cumulativePaid += p.premium;
                }
                // ถ้าเลยปีที่ต้องจ่ายเบี้ยแล้ว ต้นทุนสะสมจะคงที่เท่าเดิม (ไม่ได้จ่ายเพิ่ม)

                // 2. คำนวณมูลค่าเวนคืน (จาก % ของทุนประกัน)
                let cvValue = 0;
                let rate = 0;
                if (i < p.cvRate.length) {
                    rate = p.cvRate[i];
                    // Formula: (SumAssured * Rate) / 100
                    cvValue = (p.sumAssured * rate) / 100;
                }

                // 3. คำนวณกำไร/ขาดทุน
                const profit = cvValue - cumulativePaid;
                const profitPct = (cumulativePaid > 0) ? (profit / cumulativePaid) * 100 : -100;

                // Styling
                const isBreakeven = profit >= 0;
                const profitColor = isBreakeven ? 'text-green-600' : 'text-red-500';
                const rowClass = isBreakeven ? 'bg-green-50/30' : '';
                const icon = isBreakeven ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : '<i class="fa-solid fa-circle-xmark text-gray-300"></i>';

                const tr = document.createElement('tr');
                tr.className = `hover:bg-gray-50 transition ${rowClass}`;
                tr.innerHTML = `
                    <td class="table-cell font-medium">
                        <span class="bg-gray-100 text-gray-600 py-1 px-2 rounded text-xs mr-2">${yearNum}</span>
                        ${calendarYear}
                    </td>
                    <td class="table-cell text-right text-gray-600">${formatMoney(cumulativePaid)}</td>
                    <td class="table-cell text-right text-gray-500">${rate.toFixed(2)}%</td>
                    <td class="table-cell text-right font-bold text-indigo-600">${formatMoney(cvValue)}</td>
                    <td class="table-cell text-right ${profitColor}">${formatMoney(profit)}</td>
                    <td class="table-cell text-right font-bold ${profitColor}">${profitPct.toFixed(2)}%</td>
                    <td class="table-cell text-center">${icon}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        // ==========================================
        // 4. GOAL SEEK CALCULATOR
        // ==========================================
        function calculateTargetYear() {
            const target = parseFloat(document.getElementById('targetProfitInput').value);
            const resultDiv = document.getElementById('targetResult');
            const p = currentPolicy;

            if (isNaN(target)) {
                alert("กรุณาระบุ % กำไรที่ต้องการ");
                return;
            }

            let foundYear = -1;
            let cumulativePaid = 0;

            for (let i = 0; i < p.cvRate.length; i++) {
                const yearNum = i + 1;

                // Calculate Cost
                if (yearNum <= p.duration) {
                    cumulativePaid += p.premium;
                }

                // Calculate Value
                const rate = p.cvRate[i];
                const cvValue = (p.sumAssured * rate) / 100;
                
                // Calculate Profit %
                const profit = cvValue - cumulativePaid;
                const profitPct = (cumulativePaid > 0) ? (profit / cumulativePaid) * 100 : -100;

                if (profitPct >= target) {
                    foundYear = yearNum;
                    break;
                }
            }

            if (foundYear !== -1) {
                const startYear = moment(p.startDate);
                const targetDate = startYear.clone().add(foundYear - 1, 'years').format('YYYY');
                
                document.getElementById('resTargetPct').textContent = target;
                document.getElementById('resYear').textContent = foundYear;
                document.getElementById('resYearAD').textContent = targetDate;
                
                resultDiv.classList.remove('hidden');
                resultDiv.classList.remove('bg-red-900/50', 'border-red-500');
                resultDiv.classList.add('bg-white/10', 'border-white/20');
            } else {
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `<p class="text-red-300 text-sm">ไม่พบปีที่ได้กำไร ${target}% ภายในระยะเวลาของข้อมูลที่มี</p>`;
            }
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(num);
        }

        // Run
        init();

    </script>
</body>
</html>
