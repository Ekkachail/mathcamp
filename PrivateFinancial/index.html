<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Financial Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Font: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
        .card { @apply bg-white rounded-xl shadow-sm p-6 border border-gray-100; }
        .badge { @apply px-2 py-1 rounded text-xs font-medium; }
        
        /* Chart Toggles */
        .chart-toggle-btn { @apply px-3 py-1 text-xs font-medium rounded-full border transition-colors; }
        .chart-toggle-btn.active { @apply bg-indigo-600 text-white border-indigo-600; }
        .chart-toggle-btn.inactive { @apply bg-white text-gray-500 border-gray-200 hover:bg-gray-50; }

        /* Dashboard Card Hover Effect */
        .dashboard-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-wallet text-indigo-600 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">Financial Dashboard</h1>
                </div>
                <div class="flex items-center text-sm text-gray-500">
                    <span id="currentDateDisplay"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Configuration Alert -->
    <div id="configAlert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 mx-auto max-w-7xl mt-4">
        <div class="flex">
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <span class="font-bold">‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á:</span> ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Google Sheet ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML (‡∏™‡πà‡∏ß‡∏ô Script)
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Top Global Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Salary Card -->
            <div class="dashboard-card rounded-2xl p-6 bg-gradient-to-br from-emerald-500 to-teal-600 text-white shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-24 bg-white opacity-5 transform skew-x-12 translate-x-10"></div>
                <div class="absolute right-2 bottom-2 text-emerald-200 opacity-20">
                    <i class="fa-solid fa-money-bill-wave text-6xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2 opacity-90">
                        <div class="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                            <i class="fa-solid fa-wallet text-sm"></i>
                        </div>
                        <span class="text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                    </div>
                    <h2 class="text-3xl font-bold tracking-tight" id="latestSalary">...</h2>
                    <p class="text-xs text-emerald-100 mt-2 opacity-80" id="salaryDate">...</p>
                </div>
            </div>

            <!-- Fixed Monthly Expenses Card -->
            <div class="dashboard-card rounded-2xl p-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-24 bg-white opacity-5 transform skew-x-12 translate-x-10"></div>
                <div class="absolute right-2 bottom-2 text-blue-200 opacity-20">
                    <i class="fa-solid fa-file-invoice-dollar text-6xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2 opacity-90">
                        <div class="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                            <i class="fa-solid fa-calculator text-sm"></i>
                        </div>
                        <span class="text-sm font-medium">‡∏†‡∏≤‡∏£‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                    </div>
                    <h2 class="text-3xl font-bold tracking-tight" id="monthlyBurden">...</h2>
                    <p class="text-xs text-blue-100 mt-2 opacity-80">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + (‡∏£‡∏≤‡∏¢‡∏õ‡∏µ/12)</p>
                </div>
            </div>

            <!-- Est. Balance Card -->
            <div class="dashboard-card rounded-2xl p-6 bg-gradient-to-br from-violet-500 to-purple-600 text-white shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-24 bg-white opacity-5 transform skew-x-12 translate-x-10"></div>
                <div class="absolute right-2 bottom-2 text-violet-200 opacity-20">
                    <i class="fa-solid fa-piggy-bank text-6xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2 opacity-90">
                        <div class="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                            <i class="fa-solid fa-scale-balanced text-sm"></i>
                        </div>
                        <span class="text-sm font-medium">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                    </div>
                    <h2 class="text-3xl font-bold tracking-tight" id="estimatedBalance">...</h2>
                    <p class="text-xs text-violet-100 mt-2 opacity-80">Cash Flow (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö - ‡∏†‡∏≤‡∏£‡∏∞)</p>
                </div>
            </div>

            <!-- Upcoming Alerts Card -->
            <div class="dashboard-card rounded-2xl p-6 bg-gradient-to-br from-orange-400 to-amber-500 text-white shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 h-full w-24 bg-white opacity-5 transform skew-x-12 translate-x-10"></div>
                <div class="absolute right-2 bottom-2 text-orange-200 opacity-20">
                    <i class="fa-solid fa-bell text-6xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2 opacity-90">
                        <div class="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm">
                            <i class="fa-regular fa-clock text-sm"></i>
                        </div>
                        <span class="text-sm font-medium">‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</span>
                    </div>
                    <h2 class="text-3xl font-bold tracking-tight" id="upcomingCount">...</h2>
                    <p class="text-xs text-orange-50 mt-2 opacity-80">‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 30 ‡∏ß‡∏±‡∏ô</p>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Upcoming & Charts -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Upcoming Payments List -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-800">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h3>
                    </div>
                    <div class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto" id="upcomingList">
                        <div class="p-6 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    </div>
                </div>

                <!-- Expense Composition Chart -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-800">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
                        <div class="flex gap-1 bg-gray-100 p-1 rounded-full">
                            <button id="btnChartMonthly" class="chart-toggle-btn active" onclick="switchChartMode('monthly')">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                            <button id="btnChartYearly" class="chart-toggle-btn inactive" onclick="switchChartMode('yearly')">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
                        </div>
                    </div>
                    <div class="relative h-64">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: All Expenses Table -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- FILTER DROPDOWN (MODIFIED) -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                         <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fa-solid fa-layer-group text-indigo-500 mr-2"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                        </h3>
                    </div>
                    <div class="relative">
                        <select id="filterDropdown" class="block w-full p-3 pl-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm appearance-none cursor-pointer hover:bg-white transition-colors">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Categories)</option>
                            <!-- Options will be populated by JS -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- TABLE SUMMARY CARDS (Secondary stats) -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="tableSummarySection">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center">
                        <span class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        <span class="text-xl font-bold text-gray-800" id="tblSumCount">0</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center">
                        <span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏á)</span>
                        <span class="text-xl font-bold text-indigo-600" id="tblSumTotal">0 ‡∏ø</span>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-center">
                        <span class="text-xs text-gray-500">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏á)</span>
                        <span class="text-xl font-bold text-blue-600" id="tblSumMonthly">0 ‡∏ø</span>
                    </div>
                </div>

                <!-- Active Expenses Table -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-800">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Active)</h3>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-6 py-3 font-medium">‡∏á‡∏ß‡∏î</th>
                                    <th class="px-6 py-3 font-medium text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th class="px-6 py-3 font-medium text-right">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                                    <th class="px-6 py-3 font-medium">‡∏ï‡∏±‡∏î‡∏ú‡πà‡∏≤‡∏ô</th>
                                    <th class="px-6 py-3 font-medium">‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="activeExpensesTable">
                                <!-- JS will populate -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Completed Contracts -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden opacity-80 mt-8">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold text-gray-800">üéâ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß / ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3>
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">Completed</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th class="px-6 py-3 font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                    <th class="px-6 py-3 font-medium">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                    <th class="px-6 py-3 font-medium text-right">‡πÄ‡∏Ñ‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏á‡∏ß‡∏î‡∏•‡∏∞)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="completedExpensesTable">
                                <!-- JS will populate -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-400">
        <p>Dashboard Generated for Financial Tracking. Data stored in Google Sheets.</p>
    </footer>

    <!-- LOGIC SCRIPT -->
    <script>
        // ==========================================
        // ‚öôÔ∏è CONFIGURATION
        // ==========================================
        
        const useMockData = false; 
        const incomeSheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhtlb9rQlKGTGedKmHvGa6Lh_7CiDSmXUad79QABQGEr3h8Q3_mzWzD_s-We5nNxb8_qdEDDcTVINn/pub?gid=0&single=true&output=csv";
        const expenseSheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhtlb9rQlKGTGedKmHvGa6Lh_7CiDSmXUad79QABQGEr3h8Q3_mzWzD_s-We5nNxb8_qdEDDcTVINn/pub?gid=126929060&single=true&output=csv";

        // ==========================================
        // üìä MOCK DATA
        // ==========================================
        const mockIncome = [
            { Date: "2023-11-25", Amount: "48000" },
            { Date: "2023-12-25", Amount: "50000" },
            { Date: "2024-01-26", Amount: "52000" }
        ];

        const mockExpenses = [
            { Category: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï AIA", StartDate: "2020-05-15", Amount: "25000", Frequency: "Yearly", DurationYears: "20", PaymentSource: "KBank" },
            { Category: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå", StartDate: "2023-02-10", Amount: "18000", Frequency: "Yearly", DurationYears: "0", PaymentSource: "TTB" },
            { Category: "Netflix", StartDate: "2023-01-01", Amount: "419", Frequency: "Monthly", DurationYears: "0", PaymentSource: "TrueMoney" },
            { Category: "‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î", StartDate: "2023-01-05", Amount: "12000", Frequency: "Monthly", DurationYears: "0", PaymentSource: "KBank" },
            { Category: "‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏ö‡πâ‡∏≤‡∏ô", StartDate: "2023-01-05", Amount: "799", Frequency: "Monthly", DurationYears: "0", PaymentSource: "True" },
            { Category: "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô RMF", StartDate: "2023-12-01", Amount: "5000", Frequency: "Monthly", DurationYears: "0", PaymentSource: "DCA" },
            { Category: "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô SSF", StartDate: "2023-12-01", Amount: "2000", Frequency: "Monthly", DurationYears: "0", PaymentSource: "DCA" },
            { Category: "‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)", StartDate: "2018-01-01", Amount: "30000", Frequency: "Yearly", DurationYears: "5", PaymentSource: "KBank" },
            { Category: "‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå", StartDate: "2024-02-10", Amount: "2500", Frequency: "OneTime", DurationYears: "0", PaymentSource: "Make" }
        ];

        // ==========================================
        // üõ†Ô∏è VARIABLES & INIT
        // ==========================================

        document.getElementById('currentDateDisplay').textContent = moment().format('D MMMM YYYY');
        if(useMockData) document.getElementById('configAlert').classList.remove('hidden');

        let globalActiveExpenses = [];
        let globalCompletedExpenses = [];
        let globalCategoryStats = {}; 
        let currentChartInstance = null;
        let currentFilter = 'all';

        async function initDashboard() {
            let incomes, expenses;

            if (useMockData) {
                incomes = mockIncome;
                expenses = mockExpenses;
            } else {
                try {
                    incomes = await fetchData(incomeSheetCSV);
                    expenses = await fetchData(expenseSheetCSV);
                } catch (error) {
                    alert("Error loading data: " + error.message);
                    return;
                }
            }
            processData(incomes, expenses);
        }

        function fetchData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }

        // ==========================================
        // üß† SMART LOGIC & PROCESSING
        // ==========================================

        function getSmartCategoryGroup(name) {
            const n = name.toLowerCase();
            if (n.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô')) return '‡∏´‡∏°‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô';
            if (n.includes('‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô') || n.includes('rmf') || n.includes('ssf') || n.includes('dca')) return '‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡∏≠‡∏≠‡∏°';
            if (n.includes('‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î') || n.includes('‡∏ö‡πâ‡∏≤‡∏ô') || n.includes('‡πÑ‡∏ü‡∏ü‡πâ‡∏≤') || n.includes('‡∏ô‡πâ‡∏≥')) return '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢';
            if (n.includes('net') || n.includes('‡πÄ‡∏ô‡πá‡∏ï') || n.includes('spotify') || n.includes('youtube')) return '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á/‡πÄ‡∏ô‡πá‡∏ï';
            if (n.includes('‡∏£‡∏ñ') || n.includes('‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô') || n.includes('‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á')) return '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏£‡∏ñ';
            return name;
        }

        function processData(incomeData, expenseData) {
            // --- Income Logic ---
            const sortedIncome = incomeData
                .filter(i => i.Date && i.Amount)
                .sort((a, b) => new Date(b.Date) - new Date(a.Date));
            const currentSalary = sortedIncome.length > 0 ? parseFloat(sortedIncome[0].Amount) : 0;
            const salaryDate = sortedIncome.length > 0 ? sortedIncome[0].Date : "-";
            
            document.getElementById('latestSalary').textContent = formatCurrency(currentSalary);
            document.getElementById('salaryDate').textContent = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: " + moment(salaryDate).format('DD MMM YYYY');

            // --- Expense Logic ---
            let totalMonthlyBurden = 0;
            let activeExpenses = [];
            let completedExpenses = [];
            let upcomingPayments = [];
            let categoryAggregation = {};

            const today = moment();

            expenseData.forEach(item => {
                if (!item.Category || !item.Amount) return;

                const amount = parseFloat(item.Amount.replace(/,/g, ''));
                const startDate = moment(item.StartDate);
                const durationYears = parseInt(item.DurationYears) || 0;
                let monthlyCost = 0;
                let yearlyCost = 0;
                let isCompleted = false;
                let nextDueDate = null;
                let endDate = null;

                if (durationYears > 0 && item.Frequency === "Yearly") {
                    const lastPaymentDate = startDate.clone().add(durationYears - 1, 'years');
                    if (today.isAfter(lastPaymentDate.clone().endOf('year'))) {
                        isCompleted = true;
                        endDate = lastPaymentDate;
                    }
                }

                if (isCompleted) {
                    completedExpenses.push({ ...item, endDate });
                    return;
                }

                if (item.Frequency === "Monthly") {
                    monthlyCost = amount;
                    yearlyCost = amount * 12;
                    let targetDay = startDate.date();
                    let nextDue = moment().date(targetDay);
                    if (nextDue.isBefore(today, 'day')) nextDue.add(1, 'months');
                    nextDueDate = nextDue;

                } else if (item.Frequency === "Yearly") {
                    monthlyCost = amount / 12;
                    yearlyCost = amount;
                    let nextDue = moment().month(startDate.month()).date(startDate.date()).year(today.year());
                    if (nextDue.isBefore(today, 'day')) nextDue.add(1, 'years');
                    nextDueDate = nextDue;

                } else if (item.Frequency === "OneTime") {
                    monthlyCost = 0;
                    yearlyCost = 0;
                    nextDueDate = startDate;
                    if (startDate.isBefore(today.clone().subtract(1, 'months'))) return;
                }

                activeExpenses.push({ ...item, monthlyCost, nextDueDate, amount });

                if (item.Frequency !== "OneTime") {
                     totalMonthlyBurden += monthlyCost;
                     const groupName = getSmartCategoryGroup(item.Category);
                     if (!categoryAggregation[groupName]) {
                         categoryAggregation[groupName] = { monthly: 0, yearly: 0 };
                     }
                     categoryAggregation[groupName].monthly += monthlyCost;
                     categoryAggregation[groupName].yearly += yearlyCost;
                }

                if (nextDueDate) {
                    const daysDiff = nextDueDate.diff(today, 'days');
                    if (daysDiff >= 0 && daysDiff <= 30) {
                        upcomingPayments.push({
                            name: item.Category,
                            date: nextDueDate,
                            amount: amount,
                            daysLeft: daysDiff
                        });
                    }
                }
            });

            globalActiveExpenses = activeExpenses;
            globalCompletedExpenses = completedExpenses;
            globalCategoryStats = categoryAggregation;

            // Global Summary
            document.getElementById('monthlyBurden').textContent = formatCurrency(totalMonthlyBurden);
            document.getElementById('estimatedBalance').textContent = formatCurrency(currentSalary - totalMonthlyBurden);
            
            document.getElementById('upcomingCount').textContent = `${upcomingPayments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            // UI Init
            renderFilterDropdown(expenseData); // Changed from Chips to Dropdown
            renderUpcomingList(upcomingPayments);
            switchChartMode('monthly');
            
            // Initial Table Render (All)
            filterAndRenderTables('all');
        }

        // ==========================================
        // üé® UI: FILTERS (DROPDOWN MODIFIED)
        // ==========================================

        function renderFilterDropdown(allData) {
            const dropdown = document.getElementById('filterDropdown');
            const uniqueCategories = [...new Set(allData.map(item => item.Category).filter(Boolean))].sort();

            dropdown.innerHTML = '';

            // 'All' Option
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)';
            dropdown.appendChild(allOption);

            uniqueCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                dropdown.appendChild(option);
            });

            // Add Event Listener
            dropdown.addEventListener('change', (e) => {
                filterAndRenderTables(e.target.value);
            });
        }

        function filterAndRenderTables(filterValue) {
            currentFilter = filterValue;
            let filteredActive, filteredCompleted;

            if (filterValue === 'all') {
                filteredActive = globalActiveExpenses;
                filteredCompleted = globalCompletedExpenses;
            } else {
                filteredActive = globalActiveExpenses.filter(item => item.Category === filterValue);
                filteredCompleted = globalCompletedExpenses.filter(item => item.Category === filterValue);
            }

            renderActiveTable(filteredActive);
            renderCompletedTable(filteredCompleted);
            updateTableSummary(filteredActive);
        }

        function updateTableSummary(items) {
            // Calculate stats for the filtered items
            const count = items.length;
            const totalAmount = items.reduce((sum, item) => sum + item.amount, 0);
            const totalMonthly = items.reduce((sum, item) => sum + item.monthlyCost, 0);

            document.getElementById('tblSumCount').textContent = `${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('tblSumTotal').textContent = formatCurrency(totalAmount);
            document.getElementById('tblSumMonthly').textContent = formatCurrency(totalMonthly);
        }

        // ==========================================
        // üìä CHART LOGIC
        // ==========================================

        function switchChartMode(mode) {
            const btnMonthly = document.getElementById('btnChartMonthly');
            const btnYearly = document.getElementById('btnChartYearly');
            
            if (mode === 'monthly') {
                btnMonthly.classList.add('active'); btnMonthly.classList.remove('inactive');
                btnYearly.classList.add('inactive'); btnYearly.classList.remove('active');
            } else {
                btnYearly.classList.add('active'); btnYearly.classList.remove('inactive');
                btnMonthly.classList.add('inactive'); btnMonthly.classList.remove('active');
            }
            renderChart(globalCategoryStats, mode);
        }

        function renderChart(dataObj, mode) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (currentChartInstance) currentChartInstance.destroy();

            const labels = Object.keys(dataObj);
            const dataValues = labels.map(key => dataObj[key][mode]);
            
            const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6'];

            currentChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: "'Noto Sans Thai', sans-serif", size: 10 }, boxWidth: 10 } }
                    }
                }
            });
        }


        // ==========================================
        // üé® UI RENDERING
        // ==========================================

        function renderActiveTable(items) {
            const tbody = document.getElementById('activeExpensesTable');
            tbody.innerHTML = '';
            
            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</td></tr>';
                return;
            }

            items.sort((a, b) => a.nextDueDate - b.nextDueDate);

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                
                let freqBadge = '';
                if(item.Frequency === 'Yearly') freqBadge = 'bg-purple-100 text-purple-700';
                else if(item.Frequency === 'Monthly') freqBadge = 'bg-blue-100 text-blue-700';
                else freqBadge = 'bg-gray-100 text-gray-700';

                const nextDueStr = item.nextDueDate ? item.nextDueDate.format('DD MMM YYYY') : '-';
                const daysLeft = item.nextDueDate ? item.nextDueDate.diff(moment(), 'days') : -1;
                let dueClass = "text-gray-500";
                if(daysLeft >= 0 && daysLeft <= 5) dueClass = "text-red-600 font-bold";

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 flex items-center gap-2">
                        ${getIcon(item.Category)} 
                        <div>
                            <div>${item.Category}</div>
                            <div class="text-xs text-gray-400 font-normal">${getSmartCategoryGroup(item.Category)}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="badge ${freqBadge}">${item.Frequency}</span>
                        ${item.DurationYears > 0 ? `<span class="text-xs text-gray-400 ml-1">(${item.DurationYears} ‡∏õ‡∏µ)</span>` : ''}
                    </td>
                    <td class="px-6 py-4 text-right">${formatCurrency(item.amount)}</td>
                    <td class="px-6 py-4 text-right text-gray-500">${item.monthlyCost > 0 ? formatCurrency(item.monthlyCost) : '-'}</td>
                    <td class="px-6 py-4"><span class="text-xs border border-gray-300 rounded px-2 py-0.5">${item.PaymentSource}</span></td>
                    <td class="px-6 py-4 ${dueClass}">${nextDueStr}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCompletedTable(items) {
            const tbody = document.getElementById('completedExpensesTable');
            tbody.innerHTML = '';
            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
                return;
            }
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-500 line-through decoration-gray-400">${item.Category}</td>
                    <td class="px-6 py-4 text-gray-400">${moment(item.StartDate).format('YYYY')}</td>
                    <td class="px-6 py-4 text-gray-400">${item.endDate ? item.endDate.format('YYYY') : '-'}</td>
                    <td class="px-6 py-4 text-right text-gray-400">${formatCurrency(parseFloat(item.Amount))}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderUpcomingList(items) {
            const container = document.getElementById('upcomingList');
            container.innerHTML = '';
            if(items.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ <br>‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏î‡πâ! üéâ</div>`;
                return;
            }
            items.sort((a, b) => a.daysLeft - b.daysLeft);
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "px-6 py-4 flex items-center justify-between hover:bg-orange-50 transition group";
                let dayText = item.daysLeft === 0 ? "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!" : `‡∏≠‡∏µ‡∏Å ${item.daysLeft} ‡∏ß‡∏±‡∏ô`;
                let dayColor = item.daysLeft <= 3 ? "text-red-600 bg-red-100" : "text-orange-600 bg-orange-100";
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 group-hover:bg-white group-hover:shadow-sm">
                            <span class="font-bold text-sm">${item.date.format('DD')}</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-900">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.date.format('ddd, D MMM')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-gray-900">${formatCurrency(item.amount)}</p>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${dayColor}">
                            ${dayText}
                        </span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(num);
        }

        function getIcon(text) {
            if(text.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô')) return '<i class="fa-solid fa-shield-heart text-pink-500"></i>';
            if(text.includes('‡πÄ‡∏ô‡πá‡∏ï') || text.includes('Net')) return '<i class="fa-solid fa-wifi text-blue-400"></i>';
            if(text.includes('‡∏£‡∏ñ')) return '<i class="fa-solid fa-car text-indigo-500"></i>';
            if(text.includes('‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î') || text.includes('‡∏ö‡πâ‡∏≤‡∏ô')) return '<i class="fa-solid fa-house text-emerald-500"></i>';
            if(text.includes('‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô') || text.includes('‡∏´‡∏∏‡πâ‡∏ô')) return '<i class="fa-solid fa-chart-line text-green-500"></i>';
            return '<i class="fa-solid fa-receipt text-gray-400"></i>';
        }

        initDashboard();

    </script>
</body>

</html>

